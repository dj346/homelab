apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: anisonarr-application
  namespace: argocd
  labels:
    app.kubernetes.io/name: anisonarr
    app.kubernetes.io/component: application
    app.kubernetes.io/instance: anisonarr-prod-d1
    app.kubernetes.io/managed-by: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  project: default
  revisionHistoryLimit: 5
  destination:
    server: https://kubernetes.default.svc
    namespace: anisonarr-prod-d1
  sources:
    - repoURL: 'https://github.com/dj346/homelab.git'
      targetRevision: HEAD
      path: kubernetes/kube-prod-d1/anisonarr/prod-d1
      directory:
        exclude: 'application.yaml'
    - repoURL: 'https://github.com/dj346/homelab-helper.git'
      targetRevision: main
      path: .
      helm:
        valuesObject:
          global:
            appName: anisonarr
            environment: prod-d1
            defaultSecretEnabled: true
          
          postgresql:
            instances: 2
            
            databaseName: "sonarr-main"
            ownerName: "anisonarr"
            postInitSQL:
              - CREATE DATABASE "sonarr-log" OWNER anisonarr
            
            storageSize: 450Mi
            walStorageSize: 2Gi
            
            enableDefaultCertificate: true
            backupSchedule: "0 0 * * *"
          
          defaultSecretEnabled: true

          # ingresses:
          #   - serviceName: anisonarr-service
          #     portName: https
          
          statefulsets:
            - priorityClassName: low-priority

              # What ports the pod itself will expose. 
              ports: 
                - port: 443
                  portName: https
                  protocol: TCP

              volumes:
                - name: data
                  nfs:
                    server: 10.15.21.5
                    path: /mnt/user/video/
                - name: anisonarr-server-certificate-secret-volume
                  secret:
                    secretName: anisonarr-server-certificate-secret
              
              volumeClaimTemplates:
                - metadata:
                    name: anisonarr-config
                  spec:
                    accessModes: ["ReadWriteOnce"]
                    storageClassName: longhorn
                    resources:
                      requests:
                        storage: 450Mi

              containers:
              - image: lscr.io/linuxserver/sonarr:4.0.16@sha256:6f73bbba33391a338e20d836a60c86beaf2a865a89b706b339fc8cb0b8ce1559
                
                env: 
                  - name: PUID
                    value: "1000"
                  - name: PGID
                    value: "1000"
                  - name: TZ
                    value: "America/Los_Angeles"
                  - name: Sonarr__Postgres__Port
                    value: "5432"
                  - name: SONARR__POSTGRES__HOST
                    value: "anisonarr-postgresql-cluster-rw"
                  - name: SONARR__AUTH__METHOD
                    value: "External"

                  - name: SONARR__AUTH__APIKEY
                    valueFrom:
                      secretKeyRef:
                        name: anisonarr-apikey-secret
                        key: apiKey

                  - name: SONARR__SERVER__ENABLESSL
                    value: "true"
                  - name: SONARR__SERVER__SSLPORT
                    value: "443"
                  - name: SONARR__SERVER__SSLCERTPATH
                    value: "/ssl/keystore.p12"
                  - name: SONARR__SERVER__SSLCERTPASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: anisonarr-pkcs12-key-secret
                        key: password

                  - name: SONARR__POSTGRES__USER
                    valueFrom:
                      secretKeyRef:
                        name: anisonarr-postgresql-credentials-secret
                        key: username
                  - name: SONARR__POSTGRES__PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: anisonarr-postgresql-credentials-secret
                        key: password
          
                # relates to the headless statefulset service. 
                ports:
                  - name: https
                    containerPort: 443

                # startupProbeHttpGet:
                #   path: /
                #   port: https
                
                # readinessProbeHttpGet:
                #   path: /
                #   port: https
                # livenessProbeHttpGet:
                #   path: /
                #   port: https

                volumeMounts:
                  - name: anisonarr-config
                    mountPath: /config
                  - name: data
                    mountPath: /data
                  - name: anisonarr-server-certificate-secret-volume
                    mountPath: /ssl
                    readOnly: true

  syncPolicy:
    syncOptions:
      - Validate=true
      - PrunePropagationPolicy=foreground
      - CreateNamespace=true
    
    automated:
      prune: true
      selfHeal: true
    
    retry:
      limit: 5
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 5m
