# Usage:
#     mkdir -p ~/archivebox/data && cd ~/archivebox
#     curl -fsSL 'https://docker-compose.archivebox.io' > docker-compose.yml
#     docker compose run archivebox version
#     docker compose run archivebox config --set SAVE_ARCHIVE_DOT_ORG=False
#     docker compose run archivebox add --depth=1 'https://news.ycombinator.com'
#     docker compose run -T archivebox add < bookmarks.txt
#     docker compose up -d && open 'https://localhost:8000'
#     docker compose run archivebox help
# Documentation:
#     https://github.com/ArchiveBox/ArchiveBox/wiki/Docker#docker-compose

# ArchiveBox Deployment with Longhorn for storage
# This setup includes ArchiveBox, Sonic for search, and NoVNC for browser interaction
# Persistent storage is managed via Longhorn

# ArchiveBox Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: archivebox
  namespace: archivebox
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: archivebox
  template:
    metadata:
      labels:
        app: archivebox
    spec:
      restartPolicy: Always
      initContainers:
      - name: cleanup-lost-found
        image: busybox
        command: ["sh", "-c", "rm -rf /data/lost+found"]
        volumeMounts:
          - mountPath: /data
            name: archivebox-storage
      - name: init-archivebox
        image: archivebox/archivebox
        args: ['init']
        volumeMounts:
          - mountPath: /data
            name: archivebox-storage
      - name: init-sonic-config
        image: busybox
        command: ["/bin/sh", "-c"]
        args:
          - |
            mkdir -p /data/sonic/
            cat <<EOF > /data/sonic/sonic.cfg
            [server]

            # log_level = "debug"
            log_level = "warn"

            [channel]

            inet = "sonic.archivebox.svc.cluster.local:1491"
            tcp_timeout = 300

            auth_password = "\${env.SEARCH_BACKEND_PASSWORD}"

            [channel.search]

            query_limit_default = 65535
            query_limit_maximum = 65535
            query_alternates_try = 10

            suggest_limit_default = 5
            suggest_limit_maximum = 20

            [store]

            [store.kv]

            path = "/var/lib/sonic/store/kv/"

            retain_word_objects = 100000

            [store.kv.pool]

            inactive_after = 1800

            [store.kv.database]

            flush_after = 900

            compress = true
            parallelism = 2
            max_files = 100
            max_compactions = 1
            max_flushes = 1
            write_buffer = 16384
            write_ahead_log = true

            [store.fst]

            path = "/var/lib/sonic/store/fst/"

            [store.fst.pool]

            inactive_after = 300

            [store.fst.graph]

            consolidate_after = 180

            max_size = 2048
            max_words = 250000
            EOF
        volumeMounts:
        - mountPath: /data
          name: archivebox-storage
      - name: checkfile
        image: busybox
        command: ["sh", "-c", "ls -la /data; cat /data/sonic/sonic.cfg"]
        volumeMounts:
          - mountPath: /data
            name: archivebox-storage
      containers:
      - name: archivebox
        args: ["server", "--quick-init", "0.0.0.0:8000"] # 
        image: archivebox/archivebox:latest
        ports:
        - containerPort: 8000
          protocol: TCP
          name: http
        env:
        - name: ADMIN_USERNAME
          value: "admin"
        - name: ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: archivebox-admin-secret
              key: password
        - name: ALLOWED_HOSTS
          value: "*"
        - name: CSRF_TRUSTED_ORIGINS
          value: "http://archivebox.kube-prod-d1.mclacken.net"
        - name: PUBLIC_INDEX
          value: "true"
        - name: PUBLIC_SNAPSHOTS
          value: "true"
        - name: PUBLIC_ADD_VIEW
          value: "false"
        - name: SEARCH_BACKEND_ENGINE
          value: "sonic"
        - name: SEARCH_BACKEND_HOST_NAME
          value: "sonic"
        - name: SEARCH_BACKEND_PASSWORD
          valueFrom:
            secretKeyRef:
              name: archivebox-backend-secret
              key: search-backend-password
        # - name: LDAP
        #   value: "True"
        # - name: LDAP_SERVER_URI
        #   value: "ldap://lldap-service.lldap.svc.cluster.local:3890"
        # - name: LDAP_BIND_DN
        #   valueFrom:
        #     secretKeyRef:
        #       name: archivebox-bind-user-secret
        #       key: bindDN
        # - name: LDAP_BIND_PASSWORD
        #   valueFrom:
        #     secretKeyRef:
        #       name: archivebox-bind-user-secret
        #       key: bindPW
        # - name: LDAP_USER_BASE
        #   value: "dc=mclacken,dc=net"
        # - name: LDAP_USER_FILTER
        #   value: (objectClass=person) # "(&(objectClass=person)(memberOf=uid=archivebox-users,ou=groups,dc=mclacken,dc=net))"
        # - name: LDAP_USERNAME_ATTR
        #   value: "uid"
        # - name: LDAP_FIRSTNAME_ATTR
        #   value: "givenName"
        # - name: LDAP_LASTNAME_ATTR
        #   value: "sn"
        # - name: LDAP_EMAIL_ATTR
        #   value: "mail"
        resources:
          limits:
            cpu: "500m"
            memory: "512Mi"
          requests:
            cpu: "250m"
            memory: "256Mi"
        volumeMounts:
        - name: archivebox-storage
          mountPath: /data
      volumes:
      - name: archivebox-storage
        persistentVolumeClaim:
          claimName: archivebox-pvc
      

# https://github.com/ArchiveBox/ArchiveBox/pull/1214
# > There is a bit of an annoyance with how this currently works, which is that when a user logins in for the first time, 
# > they are denied because they are not "staff". Once they get denied login for the first time, an existing superuser can 
# > mark them as "superuser" and then they will be able to login properly. I tried to figure out a way to set all LDAP users 
# > to superuser by default as a workaround, but I couldn't figure it out so that is not included in this PR. For now though, 
# > this behavior is okay for me personally because user authentication is still handled centrally, even if I have to specifically 
# > set all the users I want to have superuser permissions to actually be able to login. If in the future ArchiveBox does not require 
# > any special user permissions to login, then first-time logins will succeed.