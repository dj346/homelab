apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: qbittorrent
  name: qbittorrent
  namespace: qbittorrent
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: qbittorrent
  template:
    metadata:
      labels:
        app: qbittorrent
    spec:
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - 127.0.0.1
      initContainers:
      - name: restore-from-backup
        image: alpine
        command: ["sh", "-c"]
        args:
          - |
            if [ "$RESTORE_BACKUP" = "1" ]; then
              echo "Restoring backup from original PVC..."
              apk add --no-cache rsync
              rsync -avh --delete /backup/ /data/
              echo "Restoring backup from original PVC..."
              rsync -avh --delete /backup1/ /data1/
            else
              echo "Skipping backup restore"
            fi
        env:
          - name: RESTORE_BACKUP
            value: "0" # Set this to "0" to skip restore
        volumeMounts:
          - name: qbittorrent-config
            mountPath: /data
          - name: gluetun-config
            mountPath: /data1
          # - name: qbittorrent-backup-storage
          #   mountPath: /backup
          # - name: gluetun-backup-storage
          #   mountPath: /backup1
      # optional gluetun VPN client sidecar
      # https://github.com/qdm12/gluetun
      # https://github.com/qdm12/gluetun-wiki/pull/7
      - name: gluetun # init sidecar for VPN connection
        image: "ghcr.io/qdm12/gluetun:latest" # <- you probably want this to be a set version
        restartPolicy: Always # makes this init into a sidecar container k8s 1.29
        imagePullPolicy: Always
        env:
        - name: TZ
          value: "America/Los_Angeles"
        - name: VPN_SERVICE_PROVIDER
          value: "mullvad"
        - name: VPN_TYPE
          value: "wireguard"
        - name: SERVER_CITIES
          value: "San Jose CA"
        - name: WIREGUARD_PRIVATE_KEY
          valueFrom:
            secretKeyRef:
              name: wireguard-config
              key: WIREGUARD_PRIVATE_KEY
        - name: WIREGUARD_ADDRESSES
          valueFrom:
            secretKeyRef:
              name: wireguard-config
              key: WIREGUARD_ADDRESSES
        - name: FIREWALL_DEBUG
          value: "on"
        - name: FIREWALL_INPUT_PORTS
          value: "8080,6881" # <- the port for qbittorrent container otherwise blocked by gluetun firewall in same pod
        livenessProbe:
          exec:
            command: ["/gluetun-entrypoint", "healthcheck"]
          initialDelaySeconds: 10  # corresponds to start-period
          periodSeconds: 5         # corresponds to interval
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command: ["/gluetun-entrypoint", "healthcheck"]
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 3
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
        lifecycle:
          postStart:
            exec:
              command: ["/bin/sh", "-c", "(ip rule del table 51820; ip -6 rule del table 51820) || true"]
        volumeMounts:
            - name: gluetun-config
              mountPath: /gluetun
      - name: wait-for-gluetun
        image: busybox
        command:
        - sh
        - -c
        - |
          sleep 30
          while ! ping -c 1 8.8.8.8; do
            echo "Waiting for VPN to establish connectivityâ€¦ Retrying in 5"
            sleep 5
          done
          echo "VPN is up!"
      containers:
        - name:  qbittorrent
          image:  lscr.io/linuxserver/qbittorrent:latest
          env:
          - name: PUID
            value: "1000"
          - name: PGID
            value: "1000"
          - name: TZ
            value: "America/Los_Angeles"
          - name: WEBUI_PORT
            value: "8080"
          - name: TORRENTING_PORT
            value: "6881"
          ports:
          - containerPort:  6881
            name: torrents
          - containerPort: 8080
            name:  qbittorrent-web
          volumeMounts:
          - name: qbittorrent-config
            mountPath: /config
          - name: downloads
            mountPath: /downloads
          - name: media-downloads
            mountPath: /data
          - name: data2
            mountPath: /data2
      volumes:
        - name: downloads
          nfs:
            server: 10.15.21.5
            path: /mnt/user/archives/websites/torrent
        - name: media-downloads
          nfs:
            server: 10.15.21.5
            path: /mnt/user/video/
        - name: data2
          nfs:
            server: 10.15.21.5
            path: /mnt/user/adult/
        - name: qbittorrent-config
          persistentVolumeClaim:
            claimName: qbittorrent-pvc
        - name: gluetun-config
          persistentVolumeClaim:
            claimName: gluetun-pvc

