apiVersion: apps/v1
kind: Deployment
metadata:
  name: archivebox
  namespace: archivebox
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: archivebox
  template:
    metadata:
      labels:
        app: archivebox
    spec:
      restartPolicy: Always
      initContainers:
      - name: wait-for-sonic
        image: busybox
        command: ["sh", "-c"]
        args:
          - |
            echo "Waiting for sonic-service:1491 to be reachable..."
            until nc -zv sonic-service 1491; do
              echo "Still waiting for Sonic..."
              sleep 2
            done
            echo "Sonic is up!"
      - name: cleanup-lost-found
        image: busybox
        command: ["sh", "-c", "rm -rf /data/lost+found"]
        volumeMounts:
          - mountPath: /data
            name: archivebox-storage
      - name: init-archivebox
        image: archivebox/archivebox
        args: ['init']
        volumeMounts:
          - name: archivebox-storage
            mountPath: /data
          - name: archivebox-nfs
            mountPath: /data/archive
      - name: init-sonic
        image: archivebox/archivebox
        args: ['update', '--index-only']
        volumeMounts:
          - name: archivebox-storage
            mountPath: /data
          - name: archivebox-nfs
            mountPath: /data/archive
      containers:
      - name: archivebox
        args: ["server", "--quick-init"] # 
        image: archivebox/archivebox:latest
        ports:
        - containerPort: 8000
          protocol: TCP
          name: http
        env:
        - name: ADMIN_USERNAME
          value: "admin"
        - name: ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: archivebox-admin-secret
              key: password
        - name: ALLOWED_HOSTS
          value: "*"
        - name: CSRF_TRUSTED_ORIGINS
          value: "http://archivebox.kube-prod-d1.mclacken.net"
        - name: PUBLIC_INDEX
          value: "true"
        - name: PUBLIC_SNAPSHOTS
          value: "true"
        - name: PUBLIC_ADD_VIEW
          value: "false"
        - name: SEARCH_BACKEND_ENGINE
          value: "sonic"
        - name: SEARCH_BACKEND_HOST_NAME
          value: "sonic-service"
        - name: SEARCH_BACKEND_PASSWORD
          value: "SomeSecretPassword"
        - name: YOUTUBEDL_ARGS
          value: '["--write-description", "--write-info-json", "--write-annotations", "--write-thumbnail", "--no-call-home", "--write-sub", "--all-subs", "--write-auto-sub", "--convert-subs=srt", "--yes-playlist", "--continue", "--ignore-errors", "--geo-bypass", "--add-metadata", "--write-comments"]'
        resources:
            limits:
              memory: "1536Mi"
              cpu: "1"
        volumeMounts:
          - name: archivebox-storage
            mountPath: /data
          - name: archivebox-nfs
            mountPath: /data/archive
      volumes:
        - name: archivebox-storage
          persistentVolumeClaim:
            claimName: archivebox-pvc
        - name: archivebox-nfs
          nfs:
            server: 10.15.21.132
            path: /mnt/user/archives/websites/archivebox
    