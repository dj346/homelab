apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: sabnzbd
  name: sabnzbd
  namespace: sabnzbd
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: sabnzbd
  template:
    metadata:
      labels:
        app: sabnzbd
    spec:
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - 127.0.0.1
      initContainers:
      # optional gluetun VPN client sidecar
      # https://github.com/qdm12/gluetun
      # https://github.com/qdm12/gluetun-wiki/pull/7
      - name: gluetun # init sidecar for VPN connection
        image: "ghcr.io/qdm12/gluetun:latest@sha256:8e49e90c1bdeabc15c900afc2f74cfaea5c905aaa7e694722e423a560fd129f2" # <- you probably want this to be a set version
        restartPolicy: Always # makes this init into a sidecar container k8s 1.29
        imagePullPolicy: Always
        env:
        - name: TZ
          value: "America/Los_Angeles"
        - name: VPN_SERVICE_PROVIDER
          value: "mullvad"
        - name: VPN_TYPE
          value: "wireguard"
        - name: WIREGUARD_PRIVATE_KEY
          valueFrom:
            secretKeyRef:
              name: wireguard-config
              key: WIREGUARD_PRIVATE_KEY
        - name: SERVER_CITIES
          value: "San Jose CA"
        - name: WIREGUARD_ADDRESSES
          valueFrom:
            secretKeyRef:
              name: wireguard-config
              key: WIREGUARD_ADDRESSES
        - name: FIREWALL_DEBUG
          value: "on"
        - name: FIREWALL_INPUT_PORTS
          value: "8080" 
        livenessProbe:
          exec:
            command: ["/gluetun-entrypoint", "healthcheck"]
          initialDelaySeconds: 10  # corresponds to start-period
          periodSeconds: 5         # corresponds to interval
          # timeoutSeconds: 5
          # failureThreshold: 3
        readinessProbe:
          exec:
            command: ["/gluetun-entrypoint", "healthcheck"]
          initialDelaySeconds: 10
          periodSeconds: 5
          # timeoutSeconds: 5
          # failureThreshold: 3
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
        lifecycle:
          postStart:
            exec:
              command: ["/bin/sh", "-c", "(ip rule del table 51820; ip -6 rule del table 51820) || true"]
        volumeMounts:
            - name: gluetun-config
              mountPath: /gluetun
      - name: wait-for-gluetun
        image: busybox@sha256:b3255e7dfbcd10cb367af0d409747d511aeb66dfac98cf30e97e87e4207dd76f
        command:
        - sh
        - -c
        - |
          sleep 30
          while ! ping -c 1 8.8.8.8; do
            echo "Waiting for VPN to establish connectivityâ€¦ Retrying in 5"
            sleep 5
          done
          echo "VPN is up!"
      - name: init-config
        image: busybox@sha256:b3255e7dfbcd10cb367af0d409747d511aeb66dfac98cf30e97e87e4207dd76f
        command:
          - sh
          - -c
          - cp /defaults/sabnzbd.ini /config/sabnzbd.ini
        volumeMounts:
          - name: sabnzbd-config-ini
            mountPath: /defaults/sabnzbd.ini
            subPath: sabnzbd.ini
            readOnly: true
          - name: sabnzbd-config
            mountPath: /config
      containers:
        - name: sabnzbd
          image: lscr.io/linuxserver/sabnzbd:latest@sha256:1a26f56dfc047b62d5ddc20bc92bdebfbe7c3cb58d2d3523958838a09182d77a
          env:
          - name: PUID
            value: "1000"
          - name: PGID
            value: "1000"
          - name: TZ
            value: "America/Los_Angeles"
          ports:
          - name: http
            containerPort: 8080
          volumeMounts:
          - name: sabnzbd-config
            mountPath: /config
          - name: data
            mountPath: /data
          - name: data2
            mountPath: /data2
      volumes:
        - name: data
          nfs:
            server: 10.15.21.5
            path: /mnt/user/video/
            readOnly: false
        - name: data2
          nfs:
            server: 10.15.21.5
            path: /mnt/user/adult/
        - name: sabnzbd-config
          persistentVolumeClaim:
            claimName: sabnzbd-pvc
            readOnly: false
        - name: gluetun-config
          persistentVolumeClaim:
            claimName: gluetun-pvc
            readOnly: false
        - name: sabnzbd-config-ini
          configMap:
            name: sabnzbd-config
            # optional: only if you want to mount that one key
            items:
            - key: sabnzbd.ini
              path: sabnzbd.ini
        

