apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  name: loki-bucket
  namespace: loki
  labels:
    app.kubernetes.io/name: loki
    app.kubernetes.io/component: tsdb
spec:    
  requestAutoCert: false

  exposeServices: 
    minio: false
    console: false

  features:
    domains: 
      minio:
        - https://loki-minio.kube-prod-d1.mclacken.net
      console: https://loki-minio-console.kube-prod-d1.mclacken.net
  
  configuration:
    name: minio-secret

  # env:
  #   - name: MINIO_BROWSER_REDIRECT_URL
  #     value: https://loki-minio.kube-prod-d1.mclacken.net
  #   - name: MINIO_ROOT_USER
  #     value: root-user
  #     valueFrom:
  #       secretKeyRef:
  #         name: minio-creds
  #         key: root-user
  #         optional: false
  #   - name: MINIO_ROOT_PASSWORD
  #     value: root-password
  #     valueFrom:
  #       secretKeyRef:
  #         name: minio-creds
  #         key: root-password
  #         optional: false
  #   - name: MINIO_REGION
  #     value: us-west-1
  #   - name: MINIO_REGION_NAME
  #     value: us-west-1

  buckets: 
    - name: loki-chunks
      region: us-west-1
      objectLock: false
    - name: loki-ruler
      region: us-west-1
      objectLock: false
    - name: loki-admin
      region: us-west-1
      objectLock: false

  serviceMetadata: 
    minioServiceLabels:
      app.kubernetes.io/name: loki
      app.kubernetes.io/component: tsdb
    minioServiceAnnotations: {}
    consoleServiceLabels:
      app.kubernetes.io/name: loki
      app.kubernetes.io/component: tsdb
    consoleServiceAnnotations: {}
    kesServiceLabels:
      app.kubernetes.io/name: loki
      app.kubernetes.io/component: tsdb
    kesServiceAnnotations: {}

  poolsMetadata:
    annotations: {}
    labels:
      app.kubernetes.io/name: loki
      app.kubernetes.io/component: tsdb

  pools:
    - servers: 4
      name: pool-1
      volumesPerServer: 1
      
      labels: 
        app.kubernetes.io/name: loki
        app.kubernetes.io/component: tsdb
      annotations: { }

      volumeClaimTemplate:
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata: 
          name: pool-1
          namespace: loki
          labels:
            app.kubernetes.io/name: loki
            app.kubernetes.io/component: tsdb
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 5Gi
          storageClassName: longhorn-strict-local
        status: { }
      
      resources: { }

      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
        runAsNonRoot: true

      containerSecurityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault
  
  # metrics:
  #   enabled: false
  #   port: 9000
  #   protocol: http

  # Directs the Operator to add the Tenant's metric scrape configuration to an existing Kubernetes Prometheus deployment managed by the Prometheus Operator.
  prometheusOperator: false

  logging: { }
