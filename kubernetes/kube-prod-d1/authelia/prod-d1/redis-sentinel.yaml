apiVersion: redis.redis.opstreelabs.in/v1beta2
kind: RedisSentinel
metadata:
  name: authelia-redis-sentinel
  namespace: authelia-prod-d1
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/component: redis-sentinel
    app.kubernetes.io/instance: authelia-prod-d1
    app.kubernetes.io/managed-by: argocd
spec:
  clusterSize: 3

  # Scheduling
  nodeSelector: {}
  priorityClassName: critical-priority

  affinity:
    podAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            topologyKey: kubernetes.io/hostname
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authelia
                app.kubernetes.io/instance: authelia-prod-d1
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            topologyKey: kubernetes.io/hostname
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authelia
                app.kubernetes.io/instance: authelia-prod-d1
                app.kubernetes.io/component: database-sentinel

  tolerations: []
  topologySpreadConstraints: []

  # Security
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000

    fsGroup: 1000
    fsGroupChangePolicy: "OnRootMismatch"

    seccompProfile.type: RuntimeDefault

  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000

    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true

    capabilities.drop:
      - ALL

    seccompProfile.type: RuntimeDefault

  # Lifecycle / networking
  terminationGracePeriodSeconds: 30
  hostPort: 0

  # Probes (example-shaped)
  readinessProbe:
    exec:
      command: ["sh", "-c", "redis-cli -p 26379 ping | grep -q PONG"]
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 2
    failureThreshold: 3

  livenessProbe:
    exec:
      command: ["sh", "-c", "redis-cli -p 26379 ping | grep -q PONG"]
    initialDelaySeconds: 15
    periodSeconds: 20
    timeoutSeconds: 2
    failureThreshold: 3


  # Env (example-shaped)
  env: []

  # KubernetesConfig
  kubernetesConfig:
    image: quay.io/opstree/redis-sentinel:v7.0.12@sha256:cb2b039352fc6d311fd4c6f2af5f9b0e022b2ac65ea90423f0d3cfabffc78b23
    imagePullPolicy: IfNotPresent

    imagePullSecrets: []

    updateStrategy:
      type: RollingUpdate

    resources: {}

    # redisSecret:
    #   name: redis-auth
    #   key: password

    persistentVolumeClaimRetentionPolicy:
      whenDeleted: Retain
      whenScaled: Retain

    service:
      serviceType: ClusterIP
      annotations: {}

      headless:
        enabled: true
        type: ClusterIP
        additionalAnnotations: {}

    ignoreAnnotations: []

    minReadySeconds: 10

  # Sentinel config (the object specific to this CRD)
  redisSentinelConfig: 
    redisPort: "6379"
    quorum: "2"
    masterGroupName: "authelia-master"
    redisReplicationName: "authelia-redis-replication"
    redisReplicationPassword:
      secretKeyRef:
        name: redis-auth
        key: password
    # additionalSentinelConfig: |
    #   # extra sentinel.conf lines
    #   sentinel deny-scripts-reconfig yes
    # parallelSyncs: "1"
    # failoverTimeout: "10000"
    # downAfterMilliseconds: "5000"
    # resolveHostnames: "no"
    # announceHostnames: "no"
  
  # Optional exporter
  redisExporter:
    enabled: true
    port: 9121
    image: quay.io/opstree/redis-exporter:v1.60.0
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        cpu: "200m"
        memory: "128Mi"
    imagePullPolicy: IfNotPresent
    env:
      - name: EXPORTER_DEBUG
        value: "false"
    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false


  # TLS
  TLS:
    ca: ca.crt
    cert: tls.crt
    key: tls.key
    secret:
      secretName: redis-tls
      optional: false

  # PDB
  pdb:
    enabled: true
    minAvailable: 2
    maxUnavailable: 1

  # Init container
  initContainer:
    enabled: true
    image: busybox:1.36@sha256:b9598f8c98e24d0ad42c1742c32516772c3aa2151011ebaf639089bd18c605b8
    imagePullPolicy: IfNotPresent
    resources:
      requests:
        cpu: "10m"
        memory: "16Mi"
      limits:
        cpu: "50m"
        memory: "64Mi"
    env:
      - name: INIT_EXAMPLE
        value: "1"
    command: ["sh", "-c"]
    args:
      - |
        echo "init sentinel"; ls -la /etc/redis || true
    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false

  # Sidecars
  sidecars:
    - name: log-sidecar
      image: busybox:1.36@sha256:b9598f8c98e24d0ad42c1742c32516772c3aa2151011ebaf639089bd18c605b8
      imagePullPolicy: IfNotPresent
      resources:
        requests:
          cpu: "10m"
          memory: "16Mi"
      env:
        - name: LOG_LEVEL
          value: "info"
      mountPath:
        - name: sentinel-extra
          mountPath: /etc/sentinel-extra
      command: ["sh", "-c"]
      ports:
        - name: http
          containerPort: 8080
      securityContext:
        runAsNonRoot: true
        allowPrivilegeEscalation: false

  # Service account
  serviceAccountName: redis-sa

  # Extra volume mounts (AdditionalVolume)
  volumeMount:
    volume:
      - name: sentinel-extra
        configMap:
          name: sentinel-extra-config
    mountPath:
      - name: sentinel-extra
        mountPath: /etc/sentinel-extra
        readOnly: true

# # # apiVersion: redis.redis.opstreelabs.in/v1beta2
# # # kind: RedisSentinel
# # # metadata:
# # #   name: redis-sentinel
# # #   namespace: authelia-prod-d1
# # # spec:
# # #   clusterSize: 3

# # #   redisSentinelConfig:
# # #     redisReplicationName: redis-replication

# # #   kubernetesConfig:
# # #     image: quay.io/opstree/redis-sentinel:latest@sha256:5d55bcd922130df2a7739d4ea9a05c4ca75e301e31554952ea8d60329da110f4
# # #     imagePullPolicy: IfNotPresent
