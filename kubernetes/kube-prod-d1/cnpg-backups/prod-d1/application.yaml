apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cnpg-backups-application
  namespace: argocd
  labels:
    app.kubernetes.io/name: cnpg-backups
    app.kubernetes.io/component: application
    app.kubernetes.io/instance: cnpg-backups-prod-d1
    app.kubernetes.io/managed-by: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    description: "ArgoCD managed deployment for SeaweedFS Backups (CloudNative Postgres Containers) application in production"
spec:
  project: default
  revisionHistoryLimit: 5
  destination:
    server: https://kubernetes.default.svc
    namespace: cnpg-backups
  sources:
    - repoURL: https://seaweedfs.github.io/seaweedfs/helm
      chart: seaweedfs
      targetRevision: 4.0.400
      helm:
        valuesObject:
          # image:
          #   registry: ""
          #   repository: ""
          #   tag: ""

          global:
            loggingLevel: 1
            createClusterRole: true
            enableSecurity: true
            masterServer: seaweedfs-master.cnpg-backups.kube-prod-d1i.mclacken.net:9333

            securityConfig:
              jwtSigning: 
                volumeWrite: true   # -> [jwt.signing]
                volumeRead: false   # -> [jwt.signing.read]
                filerWrite: true    # -> [jwt.filer_signing]
                filerRead: false    # -> [jwt.filer_signing.read]

            monitoring:
              enabled: false
              additionalLabels: {}

            extraEnvironmentVars:
              WEED_CLUSTER_DEFAULT: "backup-seaweedfs-prod-d1"
              WEED_CLUSTER_SW_MASTER: "seaweedfs-master.cnpg-backups.kube-prod-d1i.mclacken.net:9333"
              WEED_CLUSTER_SW_FILER: "seaweedfs-filer-client.cnpg-backups.kube-prod-d1i.mclacken.net:8888"

              WEED_JWT_SIGNING_KEY:
                secretKeyRef:
                  name: swb-jwt-signing-key-template-secret
                  key: signingKey
          
          certificates:
            externalCertificates:
              # This will avoid the need to use cert-manager and will rely on providing your own external certificates and CA
              # you will need to store your provided certificates in the secret read by the different services:
              # seaweedfs-master-cert, seaweedfs-filer-cert, etc. Can see any statefulset definition to see secret names
              enabled: true
          
          master:
            enabled: true
            # imageOverride: null
            # restartPolicy: null
            replicas: 3

            disableHttp: false # if true, only gRPC operations are allowed; HTTP endpoints disabled (more locked-down).
            port: 9333
            grpcPort: 19333
            metricsPort: 9327

            volumeSizeLimitMB: 1000 # 1GB per volume limit 
            loggingOverrideLevel: null
            garbageThreshold: null # fraction of “wasted” space before vacuum/compaction kicks in (e.g. 0.3 means 30% garbage).
            metricsIntervalSec: 15
            
            resumeState: true # resume previous master state at startup (useful for HA clusters).
            raftHashicorp: false # use Hashicorp Raft implementation instead of the built-in one.
            raftBootstrap: false
        
            data:
              type: "persistentVolumeClaim"
              size: "20Gi"
              storageClass: "longhorn-strict-local"
              annotations: {}

            logs:
              type: "emptyDir"
                
            sidecars: []
            initContainers: ""
            extraVolumes: ""
            extraVolumeMounts: ""

            podLabels: {}
            podAnnotations: {}
            annotations: {}
            resources: {}

            ##### May need to be edited. #####
            affinity: |
              podAntiAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  - labelSelector:
                      matchLabels:
                        app.kubernetes.io/name: seaweedfs
                        app.kubernetes.io/instance: cnpg-backups-application
                        app.kubernetes.io/component: master
                    topologyKey: kubernetes.io/hostname
            # topologySpreadConstraints: |
            #   - maxSkew: 1
            #     topologyKey: topology.kubernetes.io/node
            #     whenUnsatisfiable: ScheduleAnyway
            #     labelSelector:
            #       matchLabels:
            #         app.kubernetes.io/name: seaweedfs
            #         app.kubernetes.io/instance: cnpg-backups-application
            #         app.kubernetes.io/component: master

            priorityClassName: ""
            serviceAccountName: ""
            
            podSecurityContext:
              runAsUser: 1000        # non-root UID
              runAsGroup: 1000       # non-root GID
              fsGroup: 1000          # group that owns mounted volumes
            containerSecurityContext:
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              runAsUser: 1000

            # Aggressive volume growth settings: 
            # extraEnvironmentVars:
            #   WEED_MASTER_VOLUME_GROWTH_COPY_1: '7'
            #   WEED_MASTER_VOLUME_GROWTH_COPY_2: '6'
            #   WEED_MASTER_VOLUME_GROWTH_COPY_3: '3'
            #   WEED_MASTER_VOLUME_GROWTH_COPY_OTHER: '1'

            # livenessProbe:
            #   enabled: true
            #   httpGet:
            #     path: /cluster/status
            #     scheme: HTTP
            #   initialDelaySeconds: 20
            #   periodSeconds: 30
            #   successThreshold: 1
            #   failureThreshold: 4
            #   timeoutSeconds: 10

            # readinessProbe:
            #   enabled: true
            #   httpGet:
            #     path: /cluster/status
            #     scheme: HTTP
            #   initialDelaySeconds: 10
            #   periodSeconds: 45
            #   successThreshold: 2
            #   failureThreshold: 100
            #   timeoutSeconds: 10

          volume:
            enabled: true
            imageOverride: null
            restartPolicy: null
            loggingOverrideLevel: null
            replicas: 2

            port: 8080
            grpcPort: 18080
            metricsPort: 9327

            minFreeSpacePercent: 7 # when only 7% disk left, stop writing to that volume.
            dataDirs:
              - name: data
                type: "persistentVolumeClaim"
                size: 500Gi
                storageClass: longhorn-strict-local
                maxVolumes: 0 # how many Seaweed volumes can be stored under this directory: 
                # 0 means “auto-configure” (SeaweedFS picks default, usually 7 per server on 
                # non-Windows).
                annotations: {}

            resizeHook:
              enabled: true
              # image: alpine/k8s:1.28.4

            idx:
              type: "persistentVolumeClaim"
              size: 10Gi
              storageClass: longhorn-strict-local
              annotations: {}
            
            logs:
              type: "emptyDir"

            compactionMBps: "50" # Limits background compaction / copying speed in MB/s.
            # Helps avoid compaction saturating disk/IO and impacting foreground reads/writes.

            sidecars: []
            initContainers: ""
            extraVolumes: ""
            extraVolumeMounts: ""

            podLabels: {}
            podAnnotations: {}
            annotations: {}
            resources: {}

            ##### May need to be edited. #####
            affinity: |
              podAntiAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  - labelSelector:
                      matchLabels:
                        app.kubernetes.io/name: seaweedfs
                        app.kubernetes.io/instance: cnpg-backups-application
                        app.kubernetes.io/component: volume
                    topologyKey: kubernetes.io/hostname
            # topologySpreadConstraints: ""
            priorityClassName: ""
            serviceAccountName: ""

            podSecurityContext:
              runAsUser: 1000        # non-root UID
              runAsGroup: 1000       # non-root GID
              fsGroup: 1000          # group that owns mounted volumes
            containerSecurityContext:
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              runAsUser: 1000

            extraEnvironmentVars: {}

            # livenessProbe:
            #   enabled: true
            #   httpGet:
            #     path: /healthz
            #     scheme: HTTP
            #   initialDelaySeconds: 20
            #   periodSeconds: 90
            #   successThreshold: 1
            #   failureThreshold: 4
            #   timeoutSeconds: 30

            # readinessProbe:
            #   enabled: true
            #   httpGet:
            #     path: /healthz
            #     scheme: HTTP
            #   initialDelaySeconds: 15
            #   periodSeconds: 15
            #   successThreshold: 1
            #   failureThreshold: 100
            #   timeoutSeconds: 30

          filer:
            enabled: true
            replicas: 2

            s3:
              enabled: true
              enableAuth: true
              existingConfigSecret: s3-credentials-secret

            extraEnvironmentVars:
              WEED_POSTGRES_ENABLED: "true"
              WEED_POSTGRES_HOSTNAME: "cnpg-backups-postgres-cluster-rw.cnpg-backups.kube-prod-d1i.mclacken.net."
              WEED_POSTGRES_PORT: "5432"
              WEED_POSTGRES_DATABASE: "filemeta"
              WEED_POSTGRES_USERNAME: "cnpg-backups"
              WEED_POSTGRES_PASSWORD: "seaewoodfs-password"
              WEED_POSTGRES_SSLMODE: "disable"
              # WEED_POSTGRES_CONNECTION_MAX_IDLE: 5    
              # WEED_POSTGRES_CONNECTION_MAX_OPEN: 75
              # WEED_POSTGRES_CONNECTION_MAX_LIFETIME_SECONDS: 600
              WEED_LEVELDB2_ENABLED: "false"

              
    - repoURL: 'ssh://git@gitea-ssh.gitea.svc.cluster.local:2222/dj346/homelab.git'
      targetRevision: HEAD
      path: kubernetes/kube-prod-d1/cnpg-backups/prod-d1
  syncPolicy:
    syncOptions:
      - Validate=true
      - PrunePropagationPolicy=foreground
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 5
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 5m
