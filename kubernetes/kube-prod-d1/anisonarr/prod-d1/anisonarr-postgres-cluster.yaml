apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: anisonarr-postgres-cluster
  namespace: anisonarr
  labels:
    app.kubernetes.io/name: anisonarr
    app.kubernetes.io/component: database
    app.kubernetes.io/instance: anisonarr-prod-d1
    app.kubernetes.io/managed-by: argocd
  annotations:
    description: "CloudNative PostgreSQL Cluster for Anisonarr Application"
spec:
  description: "Production PostgreSQL cluster for Anisonarr"
  imageName: ghcr.io/cloudnative-pg/postgresql:17.5

  instances: 2  # For high-availability. Adjust based on workload.
  primaryUpdateStrategy: supervised  # Controlled updates for reliability.

  # PostgreSQL configuration tuned for moderate production workload
  postgresql:
    parameters:
      shared_buffers: 512MB
      effective_cache_size: 1GB
      max_connections: "100"
      pg_stat_statements.max: "10000"
      pg_stat_statements.track: all
      auto_explain.log_min_duration: "5s"
    pg_hba:
      - host all all 10.244.0.0/16 md5

  # Initial bootstrap configuration
  bootstrap:
    initdb:
      database: anisonarrdb
      owner: anisonarr
      secret:
        name: anisonarr-pgdb-credentials-secret
    # For recovery scenarios, uncomment below:
    # recovery:
    #   backup:
    #     name: backup-name

  # Storage configuration
  storage:
    storageClass: longhorn-strict-local
    size: 5Gi  # Recommended to have more than minimal storage for production use.

  # Backup configuration (uncomment and configure if backups are desired)
  backup:
    barmanObjectStore:
      destinationPath: s3://anisonarr-backups/
      endpointURL: https://your-s3-endpoint
      s3Credentials:
        accessKeyId:
          name: backup-creds
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: backup-creds
          key: ACCESS_SECRET_KEY
      wal:
        compression: gzip
        encryption: AES256
      data:
        compression: gzip
        encryption: AES256
        immediateCheckpoint: true
        jobs: 2
    retentionPolicy: "14d"

  # Recommended Resource Requests/Limits for stable operation
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1"
      memory: "1Gi"

  # Affinity and anti-affinity rules for high-availability
  affinity:
    enablePodAntiAffinity: true
    topologyKey: topology.kubernetes.io/zone

  # Priority class for critical workloads
  priorityClassName: high-priority

  # Monitoring setup for Prometheus exporter (built-in metrics)
  monitoring:
    enablePodMonitor: true

  # Topology Spread Constraints to distribute pods
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: anisonarr
          app.kubernetes.io/component: database
