# # # apiVersion: redis.redis.opstreelabs.in/v1beta2
# # # kind: RedisReplication
# # # metadata:
# # #   name: redis-replication-all-options
# # #   namespace: default
# # # spec:
# # #   # Core
# # #   clusterSize: 3

# # #   # Pod placement / scheduling
# # #   nodeSelector:
# # #     kubernetes.io/os: linux
# # #   priorityClassName: system-cluster-critical
# # #   affinity:
# # #     podAntiAffinity:
# # #       preferredDuringSchedulingIgnoredDuringExecution:
# # #         - weight: 100
# # #           podAffinityTerm:
# # #             topologyKey: kubernetes.io/hostname
# # #             labelSelector:
# # #               matchLabels:
# # #                 app: redis
# # #   tolerations:
# # #     - key: "dedicated"
# # #       operator: "Equal"
# # #       value: "cache"
# # #       effect: "NoSchedule"
# # #   topologySpreadConstraints:
# # #     - maxSkew: 1
# # #       topologyKey: topology.kubernetes.io/zone
# # #       whenUnsatisfiable: ScheduleAnyway
# # #       labelSelector:
# # #         matchLabels:
# # #           app: redis

# # #   # Security
# # #   podSecurityContext:
# # #     runAsUser: 1000
# # #     fsGroup: 1000
# # #   securityContext:
# # #     runAsNonRoot: true
# # #     allowPrivilegeEscalation: false

# # #   # Lifecycle
# # #   terminationGracePeriodSeconds: 30
# # #   hostPort: 0

# # #   # Probes
# # #   readinessProbe:
# # #     tcpSocket:
# # #       port: 6379
# # #     initialDelaySeconds: 5
# # #     periodSeconds: 10
# # #   livenessProbe:
# # #     tcpSocket:
# # #       port: 6379
# # #     initialDelaySeconds: 15
# # #     periodSeconds: 20

# # #   # Global env (example-shaped)
# # #   env:
# # #     - name: EXAMPLE_ENV
# # #       value: "true"
# # #     - name: REDIS_PASSWORD
# # #       valueFrom:
# # #         secretKeyRef:
# # #           name: redis-auth
# # #           key: password

# # #   # KubernetesConfig (shared config)
# # #   kubernetesConfig:
# # #     image: quay.io/opstree/redis:v7.0.12
# # #     imagePullPolicy: IfNotPresent
# # #     resources:
# # #       requests:
# # #         cpu: "250m"
# # #         memory: "256Mi"
# # #       limits:
# # #         cpu: "500m"
# # #         memory: "512Mi"

# # #     redisSecret:
# # #       name: redis-auth
# # #       key: password

# # #     imagePullSecrets:
# # #       - name: regcred

# # #     updateStrategy:
# # #       type: RollingUpdate

# # #     persistentVolumeClaimRetentionPolicy:
# # #       whenDeleted: Retain
# # #       whenScaled: Retain

# # #     service:
# # #       serviceType: ClusterIP
# # #       annotations:
# # #         service.beta.kubernetes.io/aws-load-balancer-internal: "true"
# # #       includeBusPort: false
# # #       headless:
# # #         enabled: true
# # #         type: ClusterIP
# # #         additionalAnnotations:
# # #           headless.example/anno: "true"
# # #         includeBusPort: false
# # #       additional:
# # #         enabled: true
# # #         type: ClusterIP
# # #         additionalAnnotations:
# # #           additional.example/anno: "true"
# # #         includeBusPort: false

# # #     ignoreAnnotations:
# # #       - "helm.sh/hook"
# # #       - "meta.helm.sh/release-name"

# # #     minReadySeconds: 10

# # #   # Redis configuration
# # #   redisConfig:
# # #     maxMemoryPercentOfLimit: 80
# # #     dynamicConfig:
# # #       - "timeout 300"
# # #       - "tcp-keepalive 60"
# # #     additionalRedisConfig: |
# # #       # extra redis.conf lines
# # #       maxclients 20000

# # #   # Storage
# # #   storage:
# # #     keepAfterDelete: true
# # #     volumeClaimTemplate:
# # #       metadata:
# # #         name: data
# # #       spec:
# # #         accessModes: ["ReadWriteOnce"]
# # #         storageClassName: standard
# # #         resources:
# # #           requests:
# # #             storage: 5Gi
# # #     volumeMount:
# # #       volume:
# # #         - name: extra-config
# # #           configMap:
# # #             name: redis-extra-config
# # #       mountPath:
# # #         - name: extra-config
# # #           mountPath: /etc/redis/extra
# # #           readOnly: true

# # #   # TLS
# # #   TLS:
# # #     ca: ca.crt
# # #     cert: tls.crt
# # #     key: tls.key
# # #     secret:
# # #       secretName: redis-tls
# # #       optional: false

# # #   # PDB
# # #   pdb:
# # #     enabled: true
# # #     minAvailable: 2
# # #     maxUnavailable: 1

# # #   # ACL
# # #   acl:
# # #     secret:
# # #       secretName: redis-acl-secret
# # #       optional: false
# # #     persistentVolumeClaim: redis-acl-pvc

# # #   # Init container (optional)
# # #   initContainer:
# # #     enabled: true
# # #     image: busybox:1.36
# # #     imagePullPolicy: IfNotPresent
# # #     resources:
# # #       requests:
# # #         cpu: "10m"
# # #         memory: "16Mi"
# # #       limits:
# # #         cpu: "50m"
# # #         memory: "64Mi"
# # #     env:
# # #       - name: INIT_EXAMPLE
# # #         value: "1"
# # #     command: ["sh", "-c"]
# # #     args:
# # #       - |
# # #         echo "init step"; ls -la /data || true
# # #     securityContext:
# # #       runAsNonRoot: true
# # #       allowPrivilegeEscalation: false

# # #   # Sidecars
# # #   sidecars: []

# # #   # # Service account
# # #   # serviceAccountName: redis-sa

# # #   # Optional: Redis Exporter
# # #   redisExporter:
# # #     enabled: true
# # #     port: 9121
# # #     image: quay.io/opstree/redis-exporter:v1.60.0
# # #     resources:
# # #       requests:
# # #         cpu: "50m"
# # #         memory: "64Mi"
# # #       limits:
# # #         cpu: "200m"
# # #         memory: "128Mi"
# # #     imagePullPolicy: IfNotPresent
# # #     env:
# # #       - name: EXPORTER_DEBUG
# # #         value: "false"
# # #     securityContext:
# # #       runAsNonRoot: true
# # #       allowPrivilegeEscalation: false

# # #   # Optional: Sentinel embedded under replication
# # #   sentinel:
# # #     image: quay.io/opstree/redis-sentinel:v7.0.12
# # #     imagePullPolicy: IfNotPresent
# # #     resources:
# # #       requests:
# # #         cpu: "50m"
# # #         memory: "64Mi"
# # #       limits:
# # #         cpu: "200m"
# # #         memory: "128Mi"

# # #     redisSecret:
# # #       name: redis-auth
# # #       key: password

# # #     imagePullSecrets:
# # #       - name: regcred

# # #     updateStrategy:
# # #       type: RollingUpdate

# # #     persistentVolumeClaimRetentionPolicy:
# # #       whenDeleted: Retain
# # #       whenScaled: Retain

# # #     service:
# # #       serviceType: ClusterIP
# # #       annotations:
# # #         sentinel.example/anno: "true"
# # #       includeBusPort: false
# # #       headless:
# # #         enabled: true
# # #         type: ClusterIP
# # #         additionalAnnotations:
# # #           sentinel.headless/anno: "true"
# # #         includeBusPort: false
# # #       additional:
# # #         enabled: true
# # #         type: ClusterIP
# # #         additionalAnnotations:
# # #           sentinel.additional/anno: "true"
# # #         includeBusPort: false

# # #     ignoreAnnotations:
# # #       - "helm.sh/hook"

# # #     minReadySeconds: 5

# # #     additionalSentinelConfig: |
# # #       # extra sentinel.conf lines
# # #       sentinel deny-scripts-reconfig yes

# # #     quorum: "2"
# # #     parallelSyncs: "1"
# # #     failoverTimeout: "10000"
# # #     downAfterMilliseconds: "5000"
# # #     resolveHostnames: "no"
# # #     announceHostnames: "no"
# # #     size: 3

apiVersion: redis.redis.opstreelabs.in/v1beta2
kind: RedisReplication
metadata:
  name: redis-replication
  namespace: authelia-prod-d1
spec:
  clusterSize: 3

  kubernetesConfig:
    image: quay.io/opstree/redis:latest@sha256:539924b2c1446dcdea2f043af2c50bed7516623254e4984a6d926df42eb359b2
    imagePullPolicy: IfNotPresent

  storage:
    volumeClaimTemplate:
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
