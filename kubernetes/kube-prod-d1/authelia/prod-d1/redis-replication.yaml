apiVersion: redis.redis.opstreelabs.in/v1beta2
kind: RedisReplication
metadata:
  name: authelia-redis-replication
  namespace: authelia-prod-d1
spec:
  # Core
  clusterSize: 3

  # Pod placement / scheduling
  # nodeSelector: {}

  priorityClassName: critical-priority
  
  affinity:
    podAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            topologyKey: kubernetes.io/hostname
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authelia
                app.kubernetes.io/instance: authelia-prod-d1
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            topologyKey: kubernetes.io/hostname
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authelia
                app.kubernetes.io/instance: authelia-prod-d1
                app.kubernetes.io/component: database-redis


  tolerations: {}
  topologySpreadConstraints: {}

  # Security
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000

    fsGroup: 1000
    fsGroupChangePolicy: "OnRootMismatch"

    seccompProfile.type: RuntimeDefault

  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000

    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true

    capabilities.drop:
      - ALL

    seccompProfile.type: RuntimeDefault

  # Lifecycle
  terminationGracePeriodSeconds: 30
  hostPort: 6379

  # Probes
  readinessProbe:
    exec:
      command: ["sh", "-c", "redis-cli -p 6379 ping | grep -q PONG"]
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 2
    failureThreshold: 3

  livenessProbe:
    exec:
      command: ["sh", "-c", "redis-cli -p 6379 ping | grep -q PONG"]
    initialDelaySeconds: 15
    periodSeconds: 20
    timeoutSeconds: 2
    failureThreshold: 3

  # Global env (example-shaped)
  env: []

  # KubernetesConfig (shared config)
  kubernetesConfig:
    image: quay.io/opstree/redis:v7.0.12
    imagePullPolicy: IfNotPresent
    
    imagePullSecrets: {}

    updateStrategy:
      type: RollingUpdate
    
    resources: {}
    
    redisSecret:
      name: redis-auth
      key: password

    persistentVolumeClaimRetentionPolicy:
      whenDeleted: Retain
      whenScaled: Retain

    service:
      serviceType: ClusterIP
      annotations: {}
      
      headless:
        enabled: true
        type: ClusterIP
        additionalAnnotations: {}

    ignoreAnnotations: {}

    minReadySeconds: 10

  # Redis configuration
  redisConfig: {}

  # Storage
  storage:
    keepAfterDelete: true
    volumeClaimTemplate:
      metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: longhorn-strict
        resources:
          requests:
            storage: 1Gi
    
    volumeMount: {}

  # TLS
  TLS:
    ca: ca.crt
    cert: tls.crt
    key: tls.key
    secret:
      secretName: authelia-redis-replication-server-certificate-secret
      optional: false

  # PDB
  pdb:
    enabled: true
    minAvailable: 1
    maxUnavailable: 0

  # ACL
  acl:
    secret:
      secretName: authelia-redis-acl-secret
      optional: false

  # Init container
  # initContainer: {}

  # Sidecars
  # sidecars: []

  # # Service account
  # serviceAccountName: redis-sa

  # Redis Exporter (metrics)
  # redisExporter:
  #   enabled: true
  #   port: 9121
  #   image: quay.io/opstree/redis-exporter:v1.60.0
  #   resources:
  #     requests:
  #       cpu: "50m"
  #       memory: "64Mi"
  #     limits:
  #       cpu: "200m"
  #       memory: "128Mi"
  #   imagePullPolicy: IfNotPresent
  #   env:
  #     - name: EXPORTER_DEBUG
  #       value: "false"
  #   securityContext:
  #     runAsNonRoot: true
  #     allowPrivilegeEscalation: false