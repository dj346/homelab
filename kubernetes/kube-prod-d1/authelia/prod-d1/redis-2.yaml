# # # apiVersion: redis.redis.opstreelabs.in/v1beta2
# # # kind: RedisSentinel
# # # metadata:
# # #   name: redis-sentinel-all-options
# # #   namespace: default
# # # spec:
# # #   clusterSize: 3

# # #   # Scheduling
# # #   nodeSelector:
# # #     kubernetes.io/os: linux
# # #   priorityClassName: system-cluster-critical
# # #   affinity:
# # #     podAntiAffinity:
# # #       preferredDuringSchedulingIgnoredDuringExecution:
# # #         - weight: 100
# # #           podAffinityTerm:
# # #             topologyKey: kubernetes.io/hostname
# # #             labelSelector:
# # #               matchLabels:
# # #                 app: redis-sentinel
# # #   tolerations:
# # #     - key: "dedicated"
# # #       operator: "Equal"
# # #       value: "cache"
# # #       effect: "NoSchedule"
# # #   topologySpreadConstraints:
# # #     - maxSkew: 1
# # #       topologyKey: topology.kubernetes.io/zone
# # #       whenUnsatisfiable: ScheduleAnyway
# # #       labelSelector:
# # #         matchLabels:
# # #           app: redis-sentinel

# # #   # Security
# # #   podSecurityContext:
# # #     runAsUser: 1000
# # #     fsGroup: 1000
# # #   securityContext:
# # #     runAsNonRoot: true
# # #     allowPrivilegeEscalation: false

# # #   # Lifecycle / networking
# # #   terminationGracePeriodSeconds: 30
# # #   hostPort: 0

# # #   # Probes (example-shaped)
# # #   readinessProbe:
# # #     tcpSocket:
# # #       port: 26379
# # #     initialDelaySeconds: 5
# # #     periodSeconds: 10
# # #   livenessProbe:
# # #     tcpSocket:
# # #       port: 26379
# # #     initialDelaySeconds: 15
# # #     periodSeconds: 20

# # #   # Env (example-shaped)
# # #   env:
# # #     - name: SENTINEL_DEBUG
# # #       value: "false"

# # #   # KubernetesConfig
# # #   kubernetesConfig:
# # #     image: quay.io/opstree/redis-sentinel:v7.0.12
# # #     imagePullPolicy: IfNotPresent
# # #     resources:
# # #       requests:
# # #         cpu: "50m"
# # #         memory: "64Mi"
# # #       limits:
# # #         cpu: "200m"
# # #         memory: "128Mi"

# # #     redisSecret:
# # #       name: redis-auth
# # #       key: password

# # #     imagePullSecrets:
# # #       - name: regcred

# # #     updateStrategy:
# # #       type: RollingUpdate

# # #     persistentVolumeClaimRetentionPolicy:
# # #       whenDeleted: Retain
# # #       whenScaled: Retain

# # #     service:
# # #       serviceType: ClusterIP
# # #       annotations:
# # #         sentinel.service/anno: "true"
# # #       includeBusPort: false
# # #       headless:
# # #         enabled: true
# # #         type: ClusterIP
# # #         additionalAnnotations:
# # #           sentinel.headless/anno: "true"
# # #         includeBusPort: false
# # #       additional:
# # #         enabled: true
# # #         type: ClusterIP
# # #         additionalAnnotations:
# # #           sentinel.additional/anno: "true"
# # #         includeBusPort: false

# # #     ignoreAnnotations:
# # #       - "helm.sh/hook"

# # #     minReadySeconds: 10

# # #   # Optional exporter
# # #   redisExporter:
# # #     enabled: true
# # #     port: 9121
# # #     image: quay.io/opstree/redis-exporter:v1.60.0
# # #     resources:
# # #       requests:
# # #         cpu: "50m"
# # #         memory: "64Mi"
# # #       limits:
# # #         cpu: "200m"
# # #         memory: "128Mi"
# # #     imagePullPolicy: IfNotPresent
# # #     env:
# # #       - name: EXPORTER_DEBUG
# # #         value: "false"
# # #     securityContext:
# # #       runAsNonRoot: true
# # #       allowPrivilegeEscalation: false

# # #   # Sentinel config (the object specific to this CRD)
# # #   redisSentinelConfig:
# # #     additionalSentinelConfig: |
# # #       # extra sentinel.conf lines
# # #       sentinel deny-scripts-reconfig yes
# # #     quorum: "2"
# # #     parallelSyncs: "1"
# # #     failoverTimeout: "10000"
# # #     downAfterMilliseconds: "5000"
# # #     resolveHostnames: "no"
# # #     announceHostnames: "no"
# # #     redisPort: "6379"
# # #     masterGroupName: "myMaster"
# # #     redisReplicationName: "redis-replication-all-options"
# # #     redisReplicationPassword:
# # #       secretKeyRef:
# # #         name: redis-auth
# # #         key: password

# # #   # TLS
# # #   TLS:
# # #     ca: ca.crt
# # #     cert: tls.crt
# # #     key: tls.key
# # #     secret:
# # #       secretName: redis-tls
# # #       optional: false

# # #   # PDB
# # #   pdb:
# # #     enabled: true
# # #     minAvailable: 2
# # #     maxUnavailable: 1

# # #   # Init container
# # #   initContainer:
# # #     enabled: true
# # #     image: busybox:1.36
# # #     imagePullPolicy: IfNotPresent
# # #     resources:
# # #       requests:
# # #         cpu: "10m"
# # #         memory: "16Mi"
# # #       limits:
# # #         cpu: "50m"
# # #         memory: "64Mi"
# # #     env:
# # #       - name: INIT_EXAMPLE
# # #         value: "1"
# # #     command: ["sh", "-c"]
# # #     args:
# # #       - |
# # #         echo "init sentinel"; ls -la /etc/redis || true
# # #     securityContext:
# # #       runAsNonRoot: true
# # #       allowPrivilegeEscalation: false

# # #   # Sidecars
# # #   sidecars:
# # #     - name: log-sidecar
# # #       image: busybox:1.36
# # #       imagePullPolicy: IfNotPresent
# # #       resources:
# # #         requests:
# # #           cpu: "10m"
# # #           memory: "16Mi"
# # #       env:
# # #         - name: LOG_LEVEL
# # #           value: "info"
# # #       mountPath:
# # #         - name: sentinel-extra
# # #           mountPath: /etc/sentinel-extra
# # #       command: ["sh", "-c"]
# # #       ports:
# # #         - name: http
# # #           containerPort: 8080
# # #       securityContext:
# # #         runAsNonRoot: true
# # #         allowPrivilegeEscalation: false

# # #   # Service account
# # #   serviceAccountName: redis-sa

# # #   # Extra volume mounts (AdditionalVolume)
# # #   volumeMount:
# # #     volume:
# # #       - name: sentinel-extra
# # #         configMap:
# # #           name: sentinel-extra-config
# # #     mountPath:
# # #       - name: sentinel-extra
# # #         mountPath: /etc/sentinel-extra
# # #         readOnly: true

apiVersion: redis.redis.opstreelabs.in/v1beta2
kind: RedisSentinel
metadata:
  name: redis-sentinel
  namespace: authelia-prod-d1
spec:
  clusterSize: 3

  redisSentinelConfig:
    redisReplicationName: redis-replication

  kubernetesConfig:
    image: quay.io/opstree/redis-sentinel:latest@sha256:5d55bcd922130df2a7739d4ea9a05c4ca75e301e31554952ea8d60329da110f4
    imagePullPolicy: IfNotPresent
