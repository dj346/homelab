# Usage:
#     mkdir -p ~/archivebox/data && cd ~/archivebox
#     curl -fsSL 'https://docker-compose.archivebox.io' > docker-compose.yml
#     docker compose run archivebox version
#     docker compose run archivebox config --set SAVE_ARCHIVE_DOT_ORG=False
#     docker compose run archivebox add --depth=1 'https://news.ycombinator.com'
#     docker compose run -T archivebox add < bookmarks.txt
#     docker compose up -d && open 'https://localhost:8000'
#     docker compose run archivebox help
# Documentation:
#     https://github.com/ArchiveBox/ArchiveBox/wiki/Docker#docker-compose

# ArchiveBox Deployment with Longhorn for storage
# This setup includes ArchiveBox, Sonic for search, and NoVNC for browser interaction
# Persistent storage is managed via Longhorn

# ArchiveBox Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: archivebox
  namespace: archivebox
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: archivebox
  template:
    metadata:
      labels:
        app: archivebox
    spec:
      initContainers:
      - name: init-archivebox
        image: archivebox/archivebox
        args: ['init']
        volumeMounts:
          - mountPath: /data
            name: archivebox
      containers:
      - name: archivebox
        args: ["server", "--quick-init", "0.0.0.0:8000"]
        image: archivebox/archivebox:latest
        ports:
        - containerPort: 8000
          protocol: TCP
          name: http
        env:
        - name: ALLOWED_HOSTS
          value: "*"
        - name: CSRF_TRUSTED_ORIGINS
          value: "https://archivebox.kube-prod-d1.mclacken.net"
        - name: PUBLIC_INDEX
          value: "true"
        - name: PUBLIC_SNAPSHOTS
          value: "true"
        - name: PUBLIC_ADD_VIEW
          value: "false"
        - name: SEARCH_BACKEND_ENGINE
          value: "sonic"
        - name: SEARCH_BACKEND_HOST_NAME
          value: "sonic"
        - name: SEARCH_BACKEND_PASSWORD
          valueFrom:
            secretKeyRef:
              name: archivebox-backend-secret
              key: search-backend-password
        - name: LDAP
          value: "True"
        - name: LDAP_SERVER_URI
          value: "ldap://lldap-service.lldap.svc.cluster.local:3890"
        - name: LDAP_BIND_DN
          valueFrom:
            secretKeyRef:
              name: archivebox-bind-user-secret
              key: bindDN
        - name: LDAP_BIND_PASSWORD
          valueFrom:
            secretKeyRef:
              name: archivebox-bind-user-secret
              key: bindPW
        - name: LDAP_USER_BASE
          value: "dc=mclacken,dc=net"
        - name: LDAP_USER_FILTER
          value: "(&(objectClass=person)(memberof=cn=archivebox-users,ou=groups,dc=mclacken,dc=net))"
        - name: LDAP_USERNAME_ATTR
          value: "uid"
        - name: LDAP_FIRSTNAME_ATTR
          value: "givenName"
        - name: LDAP_LASTNAME_ATTR
          value: "sn"
        - name: LDAP_EMAIL_ATTR
          value: "mail"
        resources:
          limits:
            cpu: "500m"
            memory: "512Mi"
          requests:
            cpu: "250m"
            memory: "256Mi"
        volumeMounts:
        - name: archivebox-storage
          mountPath: /data
      volumes:
      - name: archivebox-storage
        persistentVolumeClaim:
          claimName: archivebox-pvc
      restartPolicy: Always
