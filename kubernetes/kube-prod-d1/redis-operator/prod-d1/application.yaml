apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: redis-operator-application
  namespace: argocd
  labels:
    app.kubernetes.io/name: redis-operator
    app.kubernetes.io/component: orchestration
    app.kubernetes.io/instance: redis-operator-prod-d1
    app.kubernetes.io/managed-by: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  project: default
  revisionHistoryLimit: 5
  destination:
    server: https://kubernetes.default.svc
    namespace: redis-operator-prod-d1

  sources:
    - repoURL: https://github.com/dj346/homelab.git
      targetRevision: HEAD
      path: kubernetes/kube-prod-d1/redis-operator/prod-d1
      directory:
        exclude: application.yaml
    - repoURL: https://ot-container-kit.github.io/helm-charts
      chart: redis-operator
      targetRevision: 0.23.0
      helm:
        valuesObject:
          # # # redisOperator:
          # # #   name: redis-operator
          # # #   imageName: quay.io/opstree/redis-operator
          # # #   # Overrides the image tag whose default is the chart appVersion.
          # # #   imageTag: ""
          # # #   # -- initContainerImageTag is the init-config init container image tag.
          # # #   # If not specified, defaults to imageTag, then falls back to chart appVersion.
          # # #   # Typically only needs to be set when using a different version for the init container.
          # # #   initContainerImageTag: "v0.23.0"
          # # #   imagePullPolicy: Always
          # # #   imagePullSecrets: []

          # # #   # Update strategy
          # # #   # strategy:
          # # #   #   type: RollingUpdate
          # # #   #   rollingUpdate:
          # # #   #     maxSurge: 25%
          # # #   #     maxUnavailable: 25%
          # # #   strategy: {}

          # # #   # Additional pod annotations
          # # #   podAnnotations: {}
          # # #   # Additional Pod labels (e.g. for filtering Pod by custom labels)
          # # #   podLabels: {}

          # # #   # Additional arguments for redis-operator container
          # # #   extraArgs: []
          # # #   # When not specified, the operator will watch all namespaces. It can be set to a specific namespace or multiple namespaces separated by commas.
          # # #   watchNamespace: ""
          # # #   # -- The DNS domain suffix used for Kubernetes service discovery.
          # # #   # Default is "cluster.local". Change this if your cluster uses a custom DNS domain.
          # # #   serviceDNSDomain: "cluster.local"
          # # #   env: []
          # # #   # If set to true, webhook server will be enabled for masterSlaveAntiAffinity feature
          # # #   # Certificate handling:
          # # #   # - If certmanager.enabled=true: cert-manager will automatically create and manage the webhook certificate
          # # #   # - If certmanager.enabled=false: A self-signed certificate will be automatically generated by Helm
          # # #   webhook: false
          # # #   automountServiceAccountToken: true

          # # #   # pprof configuration for performance profiling
          # # #   pprof:
          # # #     # Enable pprof server for performance profiling
          # # #     enabled: false
          # # #     # The address the pprof endpoint binds to
          # # #     bindAddress: ":6060"

          # # #   # metrics configuration for monitoring
          # # #   metrics:
          # # #     # Enable metrics server
          # # #     enabled: true
          # # #     # The address the metrics endpoint binds to
          # # #     bindAddress: ":8080"

          # # # resources:
          # # #   limits:
          # # #     cpu: 500m
          # # #     memory: 500Mi
          # # #   requests:
          # # #     cpu: 500m
          # # #     memory: 500Mi

          # # # replicas: 1

          # # # rbac:
          # # #   enabled: true
          # # # serviceAccountName: redis-operator

          # # # serviceAccount:
          # # #   automountServiceAccountToken: true

          # # # service:
          # # #   name: webhook-service
          # # #   namespace: redis-operator

          # # # certificate:
          # # #   name: serving-cert
          # # #   secretName: webhook-server-cert

          # # # issuer:
          # # #   # Whether to create the issuer or not. You might want to disable this if instead you
          # # #   # want to use a ClusterIssuer that you simply want to provide.
          # # #   create: true
          # # #   # You can choose Issuer or ClusterIssuer here. The first one is namespaced, the second one
          # # #   # is available for global usage.
          # # #   kind: Issuer
          # # #   type: selfSigned
          # # #   name: redis-operator-issuer
          # # #   email: shubham.gupta@opstree.com
          # # #   server: https://acme-v02.api.letsencrypt.org/directory
          # # #   privateKeySecretName: letsencrypt-prod
          # # #   solver:
          # # #     enabled: true
          # # #     ingressClass: nginx

          # # # certmanager:
          # # #   # Whether to use cert-manager for certificate management
          # # #   # Only effective when webhook=true
          # # #   # If webhook=true and certmanager.enabled=false, a self-signed certificate is automatically generated
          # # #   enabled: false
          # # #   # API version of the cert-manager CRDs
          # # #   apiVersion: "cert-manager.io/v1"

          # # # priorityClassName: ""
          # # # nodeSelector: {}
          # # # tolerateAllTaints: false
          # # # tolerations: []
          # # # affinity: {}

          # # # podSecurityContext: {}
          # # # #  fsGroup: 2000

          # # # securityContext: {}
          # # # #  capabilities:
          # # # #    drop:
          # # # #    - ALL
          # # # #  readOnlyRootFilesystem: true
          # # # #  runAsNonRoot: true
          # # # #  runAsUser: 1000

          # # # # Feature gates for alpha/experimental features
          # # # featureGates:
          # # #   # Enable generating Redis configuration using an init container instead of a regular container
          # # #   GenerateConfigInInitContainer: false

          # # # manager:
          # # #   # config values for the operator manager
          # # #   config:
          # # #     kubeClientTimeout: 60s
          # # #     # -- If value > 0, it will override the default value in the operator
          # # #     kubeClientQPS: 0.0

          service:
            namespace: redis-operator-prod-d1

          redisOperator:
            webhook: true

          certmanager:
            enabled: true

          featureGates:
            GenerateConfigInInitContainer: true

          issuer:
            create: false
            kind: ClusterIssuer
            name: vault-redis-kube-prod-d1-issuer
  syncPolicy:
    syncOptions:
      - ServerSideApply=true
      - Validate=true
      - PrunePropagationPolicy=foreground
      - CreateNamespace=true
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 5
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 5m

# helm install <redis-operator> ot-helm/redis-operator 
# --version=0.15.5 
# --appVersion=0.15.1 
# --set certificate.secretName=<YourCertSecretName> 
# --set certmanager.enabled=true 
# --set redisOperator.webhook=true 
# --namespace <redis-operator> 
# --create-namespace