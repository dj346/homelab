apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: openbao-application
  namespace: argocd
  labels:
    app.kubernetes.io/name: openbao
    app.kubernetes.io/component: application
    app.kubernetes.io/instance: openbao-prod-d1
    app.kubernetes.io/managed-by: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    description: "ArgoCD managed deployment for OpenBao application in production"
spec:
  project: default
  revisionHistoryLimit: 5
  destination:
    server: https://kubernetes.default.svc
    namespace: openbao
  sources:
    - repoURL: https://openbao.github.io/openbao-helm
      chart: openbao
      targetRevision: 0.16.2
      helm:
        valuesObject:
          # Vault Helm Chart Value Overrides
          global:
            enabled: true
            tlsDisable: false

          injector:
            enabled: true
            # Use the Vault K8s Image https://github.com/hashicorp/vault-k8s/
            image:
              repository: "hashicorp/vault-k8s"
              tag: "latest"

            # resources:
            #     requests:
            #       memory: 256Mi
            #       cpu: 250m
            #     limits:
            #       memory: 256Mi
            #       cpu: 250m

          server:
            volumes:
              - name: tls
                secret:
                  secretName: openbao-certificate-secret   # from your Certificate
                  defaultMode: 420
            volumeMounts:
              - name: tls
                mountPath: /openbao/tls
                readOnly: true
              
            # This configures the Vault Statefulset to create a PVC for data
            # storage when using the file or raft backend storage engines.
            # See https://www.vaultproject.io/docs/configuration/storage/index.html to know more
            dataStorage:
              enabled: true
              # Size of the PVC created
              size: 1Gi
              # Location where the PVC will be mounted.
              mountPath: "/openbao/data"
              # Name of the storage class to use.  If null it will use the
              # configured default Storage Class.
              storageClass: longhorn
              # Access Mode of the storage device being used for the PVC
              accessMode: ReadWriteOnce
              # Annotations to apply to the PVC
              annotations: {}

            # Use the Enterprise OR Community Image
            image:
              repository: "openbao/openbao"
              tag: "latest"

            # These Resource Limits are in line with node requirements in the
            # Vault Reference Architecture for a Small Cluster
            # resources:
            #   requests:
            #     memory: 8Gi
            #     cpu: 2000m
            #   limits:
            #     memory: 16Gi
            #     cpu: 2000m

            # For HA configuration and because we need to manually init the vault,
            # we need to define custom readiness/liveness Probe settings
            readinessProbe:
              enabled: true
              path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"
            livenessProbe:
              enabled: true
              path: "/v1/sys/health?standbyok=true"
              initialDelaySeconds: 60


            # This configures the Vault Statefulset to create a PVC for audit logs.
            # See https://www.vaultproject.io/docs/audit/index.html to know more
            auditStorage:
              enabled: true
              size: 1Gi
              storageClass: longhorn

            standalone:
              enabled: false

            # Authentication to AWS for auto unseal
            extraSecretEnvironmentVars:
              - envName: AWS_ACCESS_KEY_ID
                secretName: vault-aws-token-secret
                secretKey: AWS_ACCESS_KEY_ID
              - envName: AWS_SECRET_ACCESS_KEY
                secretName: vault-aws-token-secret
                secretKey: AWS_SECRET_ACCESS_KEY
              - envName: VAULT_PG_CONNECTION_URL
                secretName: vault-aws-token-secret
                secretKey: VAULT_PG_CONNECTION_URL

            # Run Vault in "HA" mode.
            ha:
              enabled: true
              replicas: 5
              raft:
                enabled: true
                setNodeId: true

                config: |
                  ui = true
                  cluster_name = "openbao-integrated-storage"
                  listener "tcp" {
                    tls_disable = "false"
                    address = "[::]:8200"
                    cluster_address = "[::]:8201"
                    tls_cert_file   = "/openbao/tls/tls.crt"
                    tls_key_file    = "/openbao/tls/tls.key"
                  }

                  seal "awskms" {
                    region     = "us-west-1"
                    kms_key_id = "b51776f9-44d6-44e6-8740-faa6dcc4b2cd"
                  }
                  
                  storage "raft" {
                    path = "/openbao/data"
                    retry_join {
                      leader_api_addr = "https://openbao-application-0-hs-openbao-application-internal.openbao.kube-prod-d1i.mclacken.net:8200"
                    }
                    retry_join {
                      leader_api_addr = "https://openbao-application-1-hs-openbao-application-internal.openbao.kube-prod-d1i.mclacken.net:8200"
                    }
                    retry_join {
                      leader_api_addr = "https://openbao-application-2-hs-openbao-application-internal.openbao.kube-prod-d1i.mclacken.net:8200"
                    }
                    retry_join {
                      leader_api_addr = "https://openbao-application-3-hs-openbao-application-internal.openbao.kube-prod-d1i.mclacken.net:8200"
                    }
                    retry_join {
                      leader_api_addr = "https://openbao-application-4-hs-openbao-application-internal.openbao.kube-prod-d1i.mclacken.net:8200"
                    }
                  }

                  service_registration "kubernetes" {}

          # Vault UI
          ui:
            enabled: true
            serviceType: "LoadBalancer"
            serviceNodePort: null
            externalPort: 8200
    - repoURL: 'ssh://git@gitea-ssh.gitea.svc.cluster.local:2222/dj346/homelab.git'
      targetRevision: HEAD
      path: kubernetes/kube-prod-d1/openbao/prod-d1
  syncPolicy:
    syncOptions:
      - Validate=true
      - PrunePropagationPolicy=foreground
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 5
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 5m
